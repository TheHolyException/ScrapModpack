Fant_Symboles = class()
Fant_Symboles.maxParentCount = 5
Fant_Symboles.connectionInput = sm.interactable.connectionType.logic

Fant_Symboles.map = {}

Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 0  + 0 -- 0
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 4  + 0 -- 1
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 8  + 0 -- 2
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 12 + 0 -- 3
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 16 + 0 -- 4
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 20 + 0 -- 5
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 24 + 0 -- 6
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 28 + 0 -- 7
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 32 + 0 -- 8
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 36 + 0 -- 9

Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 0  + 1 -- A
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 4  + 1 -- B
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 8  + 1 -- C
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 12 + 1 -- D
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 16 + 1 -- E
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 20 + 1 -- F
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 24 + 1 -- G
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 28 + 1 -- H
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 32 + 1 -- I
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 36 + 1 -- J

Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 0  + 2 -- K
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 4  + 2 -- L
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 8  + 2 -- M
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 12 + 2 -- N
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 16 + 2 -- O
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 20 + 2 -- P
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 24 + 2 -- Q
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 28 + 2 -- R
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 32 + 2 -- S
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 36 + 2 -- T

Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 0  + 3 -- U
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 4  + 3 -- V
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 8  + 3 -- W
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 12 + 3 -- X
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 16 + 3 -- Y
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 20 + 3 -- Z
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 24 + 3 -- -
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 28 + 3 -- =
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 32 + 3 -- !
Fant_Symboles.map[ #Fant_Symboles.map + 1 ] = 36 + 3 -- ?

Fant_Symboles.keys = {}

Fant_Symboles.keys[ "0" ] = 0  + 0
Fant_Symboles.keys[ "1" ] = 4  + 0
Fant_Symboles.keys[ "2" ] = 8  + 0
Fant_Symboles.keys[ "3" ] = 12 + 0
Fant_Symboles.keys[ "4" ] = 16 + 0
Fant_Symboles.keys[ "5" ] = 20 + 0
Fant_Symboles.keys[ "6" ] = 24 + 0
Fant_Symboles.keys[ "7" ] = 28 + 0
Fant_Symboles.keys[ "8" ] = 32 + 0
Fant_Symboles.keys[ "9" ] = 36 + 0

Fant_Symboles.keys[ "A" ] = 0  + 1
Fant_Symboles.keys[ "B" ] = 4  + 1
Fant_Symboles.keys[ "C" ] = 8  + 1
Fant_Symboles.keys[ "D" ] = 12 + 1
Fant_Symboles.keys[ "E" ] = 16 + 1
Fant_Symboles.keys[ "F" ] = 20 + 1
Fant_Symboles.keys[ "G" ] = 24 + 1
Fant_Symboles.keys[ "H" ] = 28 + 1
Fant_Symboles.keys[ "I" ] = 32 + 1
Fant_Symboles.keys[ "J" ] = 36 + 1

Fant_Symboles.keys[ "K" ] = 0  + 2
Fant_Symboles.keys[ "L" ] = 4  + 2
Fant_Symboles.keys[ "M" ] = 8  + 2
Fant_Symboles.keys[ "N" ] = 12 + 2
Fant_Symboles.keys[ "O" ] = 16 + 2
Fant_Symboles.keys[ "P" ] = 20 + 2
Fant_Symboles.keys[ "Q" ] = 24 + 2
Fant_Symboles.keys[ "R" ] = 28 + 2
Fant_Symboles.keys[ "S" ] = 32 + 2
Fant_Symboles.keys[ "T" ] = 36 + 2

Fant_Symboles.keys[ "U" ] = 0  + 3
Fant_Symboles.keys[ "V" ] = 4  + 3
Fant_Symboles.keys[ "W" ] = 8  + 3
Fant_Symboles.keys[ "X" ] = 12 + 3
Fant_Symboles.keys[ "Y" ] = 16 + 3
Fant_Symboles.keys[ "Z" ] = 20 + 3



function Fant_Symboles.server_onCreate( self )
	self.sv = {}
	self.sv.storage = self.storage:load()
	if self.sv.storage == nil then
		self.sv.storage = { Index = 1 } 
		self.storage:save( self.sv.storage )
	end
	self.network:sendToClients( "cl_setIndex", { Index = self.sv.storage.Index } )	
end

function Fant_Symboles.sv_setIndex( self, storage )
	self.sv = {}
	if self.sv.storage == nil then
		self.sv.storage = { Index = storage.Index } 
		self.storage:save( self.sv.storage )
	end
	self.network:sendToClients( "cl_setIndex", { Index = self.sv.storage.Index } )	
end

function Fant_Symboles.sv_getIndex( self )
	self.network:sendToClients( "cl_setIndex", { Index = self.sv.storage.Index } )	
end

function Fant_Symboles.cl_setIndex( self, storage )
	self.Index = storage.Index
	self:cl_setUvFrameIndex( self.Index ) 
	--print( "Index: ".. tostring( self.Index ) )
end

function Fant_Symboles.client_onCreate( self )
	self.white = "eeeeeeff"
	self.yellow = "e2db13ff"
	self.green = "19e753ff"
	self.blue = "0a3ee2ff"
	self.red = "d02525ff"
	self.Index = 1
	self.delay = 0
	self.network:sendToServer( "sv_getIndex" )	
end

function Fant_Symboles.cl_setUvFrameIndex( self, index ) 
	self.interactable:setUvFrameIndex( Fant_Symboles.map[ index ] )
end

function Fant_Symboles.getParentInputs( self )
	local parents = self.interactable:getParents()
	local hasInputs = false
	local inputIndex = 1
	if #parents >= 5 then
		hasInputs = true
		for i, parent in pairs( self.interactable:getParents() ) do
			if parent:hasOutputType( sm.interactable.connectionType.logic ) then
				if parent.active then			
					local color = tostring( sm.shape.getColor( parent.shape ) )
					if color == self.white then
						inputIndex = inputIndex + 1
					end
					if color == self.yellow then
						inputIndex = inputIndex + 2
					end
					if color == self.green then
						inputIndex = inputIndex + 4
					end
					if color == self.blue then
						inputIndex = inputIndex + 8
					end
					if color == self.red then
						inputIndex = inputIndex + 16
					end
				end
			end
		end
	end
	return hasInputs, inputIndex
end

function Fant_Symboles.server_onFixedUpdate( self, dt )
	
end

function Fant_Symboles.client_onUpdate( self, dt )
	local HasInputs, InputIndex = self:getParentInputs()
	if HasInputs then
		self:cl_setUvFrameIndex( InputIndex ) 
	end
end

function Fant_Symboles.client_canInteract( self, character )
	sm.gui.setCenterIcon( "Use" )
	local keyBindingText =  sm.gui.getKeyBinding( "Use" )
	sm.gui.setInteractionText( "", keyBindingText, "Keyboard" )
	return true
end

function Fant_Symboles.client_onInteract( self, character, state )
	if state then
		if character == sm.localPlayer.getPlayer().character then
			self.keyboardGui = sm.gui.createGuiFromLayout( "$GAME_DATA/Gui/Layouts/Fant_Keyboard.layout" )
			
			self.keyboardGui:setButtonCallback( "key_1", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_2", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_3", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_4", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_5", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_6", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_7", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_8", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_9", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_0", "cl_onKeyboard" )
			
			self.keyboardGui:setButtonCallback( "key_q", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_w", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_e", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_r", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_t", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_y", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_u", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_i", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_o", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_p", "cl_onKeyboard" )
			
			self.keyboardGui:setButtonCallback( "key_a", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_s", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_d", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_f", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_g", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_h", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_j", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_k", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_l", "cl_onKeyboard" )
			--self.keyboardGui:setButtonCallback( "key_enter", "cl_onKeyboard" )
			
			self.keyboardGui:setButtonCallback( "key_z", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_x", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_c", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_v", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_b", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_n", "cl_onKeyboard" )
			self.keyboardGui:setButtonCallback( "key_m", "cl_onKeyboard" )
			
			--self.keyboardGui:setButtonCallback( "key_del", "cl_onKeyboard" )
			--self.keyboardGui:setButtonCallback( "key_left", "cl_onKeyboard" )
			--self.keyboardGui:setButtonCallback( "key_right", "cl_onKeyboard" )
			
			--self.keyboardGui:setButtonCallback( "key_comma", "cl_onKeyboard" )
			--self.keyboardGui:setButtonCallback( "key_dot", "cl_onKeyboard" )
			--self.keyboardGui:setButtonCallback( "key_minus", "cl_onKeyboard" )
			--self.keyboardGui:setButtonCallback( "key_underscore", "cl_onKeyboard" )
			--self.keyboardGui:setButtonCallback( "key_space", "cl_onKeyboard" )
			
			self.keyboardGui:setVisible( "key_enter", false )
			self.keyboardGui:setVisible( "key_del", false )
			self.keyboardGui:setVisible( "key_left", false )
			self.keyboardGui:setVisible( "key_right", false )
			self.keyboardGui:setVisible( "key_comma", false )
			self.keyboardGui:setVisible( "key_dot", false )
			self.keyboardGui:setVisible( "key_minus", false )
			self.keyboardGui:setVisible( "key_underscore", false )
			self.keyboardGui:setVisible( "key_space", false )
			
			
			self.keyboardGui:setOnCloseCallback( "cl_onClose" )
			self.keyboardGui:open()
			self.keyboardGui:setText( "output_text", "Symboles" )
		end
	end
end

function Fant_Symboles.cl_onKeyboard( self, key )
	if key ~= nil then
		if self.keyboardOutput == nil then
			self.keyboardOutput = "Search Word"
		end		
		local input = string.sub( key, 5 )
		if input ~= "0" and input ~= "1" and input ~= "2" and input ~= "3" and input ~= "4" and input ~= "5" and input ~= "6" and input ~= "7" and input ~= "8" and input ~= "9" then
			input = input:upper()
		end
		local inputIndex = 1
		for i, k in pairs( Fant_Symboles.map ) do 
			if k == Fant_Symboles.keys[ input ] then
				inputIndex = i
				break
			end
		end
		self.network:sendToServer( "sv_setIndex", { Index = inputIndex } )
		
		self.keyboardGui:close()
	end
end

function Fant_Symboles.cl_onClose( self )
	self.keyboardGui:close()
end